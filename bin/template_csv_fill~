#!/usr/bin/env python
# coding: utf-8

from __future__ import print_function
from jinja2 import Template, Environment, FileSystemLoader
import argparse
import csv
import os

# In[65]:

parser = argparse.ArgumentParser(description="Fill template with CSV data.")

parser.add_argument('--template', '-t', help="template file to use", required=True)
parser.add_argument('--output-dir', '-o', help="where to store filled templates", default=".")
parser.add_argument('--delimiter', '-d', help="delimiter of input csv file", default="\t")
parser.add_argument('INPUT', help="input csv file", nargs="*", default=['/dev/stdin'])

args = parser.parse_args()


# In[71]:


template = open(args.template).read()

env = Environment(loader=FileSystemLoader("."),
                  block_start_string="<<%",
                  block_end_string="%>>",
                  variable_start_string="{{",
                  variable_end_string="}}",
                  comment_start_string = '\#{',
                  comment_end_string = '}',
                  line_statement_prefix = '%%-',
                  line_comment_prefix = '%#',
                  trim_blocks = True,
                  autoescape = False
                  )

template = env.get_template(args.template)

for csv_file in args.INPUT:
    print("Reading from",csv_file, "with delimiter '", args.delimiter,"'")
    with open(csv_file,"r") as fh:
        reader = csv.reader(fh, delimiter=args.delimiter)
        for i,row in enumerate(reader):
            out_path = os.path.join(args.output_dir, args.template+ "." + str(i) + ".test")
            print("Processing", row, ">", out_path)
            with open(out_path, "w") as out_file:
                out_file.write(template.render(name="123", row=row))

